{{ define "main" }}
	{{- $columnsScratch := newScratch -}}
	{{- $columnsScratch.Set "desktop" 4 -}}
	{{- $columnsScratch.Set "tablet" 3 -}}
	{{- $columnsScratch.Set "mobile" 2 -}}
	{{- with .Site.Params.photos_columns_desktop }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "desktop" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_columns_tablet }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "tablet" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_columns_mobile }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "mobile" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- $optionsScratch := newScratch -}}
	{{- $optionsScratch.Set "showAll" true -}}
	{{- $optionsScratch.Set "layout" "columns" -}}
	{{- with .Site.Params.photos_show_all }}
		{{- $value := lower (trim (printf "%v" .) " \r\n\t") -}}
		{{- if or (eq $value "false") (eq $value "0") (eq $value "no") (eq $value "off") }}
			{{- $optionsScratch.Set "showAll" false -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_layout_mode }}
		{{- $value := lower (trim (printf "%v" .) " \r\n\t") -}}
		{{- if in (slice "columns" "rows") $value }}
			{{- $optionsScratch.Set "layout" $value -}}
		{{- end }}
	{{- end }}
	{{- $layoutMode := $optionsScratch.Get "layout" -}}
	{{- $imageTracker := newScratch -}}
	{{- $imageTracker.Set "count" 0 -}}
	<ul class="masonry-grid {{ if eq $layoutMode "rows" }}masonry-grid--rows{{ else }}masonry-grid--columns{{ end }}" data-layout="{{ $layoutMode }}" style="--masonry-columns-desktop: {{ $columnsScratch.Get "desktop" }}; --masonry-columns-tablet: {{ $columnsScratch.Get "tablet" }}; --masonry-columns-mobile: {{ $columnsScratch.Get "mobile" }};">
	{{- $list := .Site.RegularPages -}}
	{{- $list = where $list "Type" "post" -}}
	{{- $category := index .Site.Taxonomies.categories (lower .Site.Params.photos_category) -}}
	{{- if $category }}
		{{- $list = $category.Pages -}}
	{{ end }}
	{{- $defaultExtensions := slice "jpg" "jpeg" "png" "gif" "webp" "avif" "heic" "heif" "tiff" "bmp" -}}
	{{- $configScratch := newScratch -}}
	{{- $configScratch.Set "extensions" $defaultExtensions -}}
	{{- with .Site.Params.photos_extensions }}
		{{- $raw := printf "%v" . -}}
		{{- $normalized := replaceRE `[;\s]+` "," $raw -}}
		{{- $candidateScratch := newScratch -}}
		{{- $candidateScratch.Set "list" (slice) -}}
		{{- range split $normalized "," }}
			{{- $ext := lower (replaceRE `[^a-z0-9]+` "" (trim . " .\r\n\t")) -}}
			{{- if and $ext (not (in ($candidateScratch.Get "list") $ext)) }}
				{{- $candidateScratch.Add "list" (slice $ext) -}}
			{{- end }}
		{{- end }}
		{{- if gt (len ($candidateScratch.Get "list")) 0 }}
			{{- $configScratch.Set "extensions" ($candidateScratch.Get "list") -}}
		{{- end }}
	{{- end }}
	{{- $extensions := $configScratch.Get "extensions" -}}
	{{- $imagePattern := printf `(?i)\.(?:%s)(?:\?.*)?$` (delimit $extensions "|") -}}
	{{- $markdownPattern := `!\[[^\]]*\]\(\s*([^)\s]+)(?:\s+["'][^"']*["'])?\s*\)` -}}
	{{- $htmlImgPattern := `<img[^>]+src=["']([^"']+)["'][^>]*>` -}}
	{{- range $page := $list }}
			{{- $scratch := newScratch -}}
			{{- $scratch.Set "photos" (slice) -}}
			{{- with $page.Params.photos }}
				{{- $photos := . -}}
				{{- $type := printf "%T" $photos -}}
			{{- if (hasPrefix $type "[]") }}
				{{- range $photos }}
					{{- $src := trim . " \r\n\t" -}}
					{{- if and $src (not (in ($scratch.Get "photos") $src)) }}
						{{- if gt (len (findRE $imagePattern $src)) 0 }}
							{{- $scratch.Add "photos" (slice $src) -}}
						{{- end }}
					{{- end }}
				{{- end }}
			{{- else if (ne $photos "") }}
				{{- $single := trim (printf "%v" $photos) " \r\n\t" -}}
				{{- if gt (len (findRE $imagePattern $single)) 0 }}
					{{- $scratch.Add "photos" (slice $single) -}}
				{{- end }}
			{{- end }}
		{{- end }}
		{{- with $page.RawContent }}
			{{- $raw := . -}}
			{{- range $match := findRE $markdownPattern $raw }}
				{{- $src := trim (replaceRE $markdownPattern `$1` $match) " \r\n\t" -}}
				{{- if and $src (gt (len (findRE $imagePattern $src)) 0) (not (in ($scratch.Get "photos") $src)) }}
					{{- $scratch.Add "photos" (slice $src) -}}
				{{- end }}
			{{- end }}
			{{- range $match := findRE $htmlImgPattern $raw }}
				{{- $src := trim (replaceRE $htmlImgPattern `$1` $match) " \r\n\t" -}}
				{{- if and $src (gt (len (findRE $imagePattern $src)) 0) (not (in ($scratch.Get "photos") $src)) }}
					{{- $scratch.Add "photos" (slice $src) -}}
				{{- end }}
			{{- end }}
		{{- end }}
		{{- $photos := $scratch.Get "photos" -}}
			{{- if gt (len $photos) 0 }}
				{{- $scratch.Set "photos_display" $photos -}}
				{{- if and (not ($optionsScratch.Get "showAll")) (gt (len $photos) 0) }}
					{{- $scratch.Set "photos_display" (slice (index $photos 0)) -}}
				{{- end }}
				{{- $display := $scratch.Get "photos_display" -}}
				{{- range $src := $display }}
					{{- $index := add ($imageTracker.Get "count") 1 -}}
					{{- $imageTracker.Set "count" $index -}}
					{{- $prefetchRows := 2 -}}
					{{- $prefetchThreshold := mul ($columnsScratch.Get "desktop") $prefetchRows -}}
					{{- $loadingAttr := "lazy" -}}
					{{- $fetchPriority := "" -}}
					{{- if le $index $prefetchThreshold }}
						{{- $loadingAttr = "eager" -}}
						{{- $fetchPriority = "high" -}}
					{{- end }}
					{{- $alt := "Photo" -}}
					{{- with $page.Title }}
						{{- $alt = plainify . -}}
					{{- end }}
					{{- $title := $page.Title -}}
					<li>
						<a href="{{ $page.Permalink }}">
							{{- $abs := $src | absURL -}}
							{{- $sizes := "(max-width: 640px) 100vw, (max-width: 1024px) 95vw, 720px" -}}
							{{- $resource := cond (or (hasPrefix $src "http://") (hasPrefix $src "https://")) nil ($page.Resources.GetMatch $src) -}}
							{{- if $resource }}
								{{- $widths := slice 400 768 1024 1440 -}}
								{{- $srcset := slice -}}
								{{- range $width := $widths }}
									{{- $derivative := $resource.Fit (printf "%dx q85" $width) -}}
									{{- if $derivative }}
										{{- $srcset = $srcset | append (printf "%s %dw" $derivative.RelPermalink $width) -}}
									{{- end }}
								{{- end }}
								{{- $default := $resource.Fit "1024x q85" -}}
								{{- if not $default }}
									{{- $default = $resource -}}
								{{- end }}
								<img src="{{ $default.RelPermalink }}" srcset="{{ delimit $srcset ", " }}" sizes="{{ $sizes }}" width="{{ $default.Width }}" height="{{ $default.Height }}" loading="{{ $loadingAttr }}" {{ if ne $fetchPriority "" }}fetchpriority="{{ $fetchPriority }}"{{ end }} decoding="async" alt="{{ $alt }}" />
							{{- else }}
								{{- $isMBPhotos := or (hasPrefix $abs "https://micro.blog/photos/") (hasPrefix $abs "http://micro.blog/photos/") -}}
								{{- $isMBUploads := or (hasPrefix $abs "https://cdn.micro.blog/") (hasPrefix $abs "https://micro.blog/uploads/") (hasPrefix $abs "https://us.uploads.micro.blog/") (hasPrefix $abs "https://eu.uploads.micro.blog/") (hasPrefix $abs "https://micro.blog/uploads/") -}}
								{{- $src300 := "" -}}
								{{- $src600 := "" -}}
								{{- $src1200 := "" -}}
								{{- if $isMBPhotos }}
									{{- $src300 = replaceRE `/photos/[^/]+/` "/photos/300x/" $abs -}}
									{{- $src600 = replaceRE `/photos/[^/]+/` "/photos/600x/" $abs -}}
									{{- $src1200 = replaceRE `/photos/[^/]+/` "/photos/1200x/" $abs -}}
								{{- else if $isMBUploads }}
									{{- $encoded := $abs | urlquery -}}
									{{- $src300 = printf "https://micro.blog/photos/300x/%s" $encoded -}}
									{{- $src600 = printf "https://micro.blog/photos/600x/%s" $encoded -}}
									{{- $src1200 = printf "https://micro.blog/photos/1200x/%s" $encoded -}}
								{{- else }}
									{{- $encoded := $abs | urlquery -}}
									{{- $src300 = printf "https://micro.blog/photos/300x/%s" $encoded -}}
									{{- $src600 = printf "https://micro.blog/photos/600x/%s" $encoded -}}
									{{- $src1200 = printf "https://micro.blog/photos/1200x/%s" $encoded -}}
								{{- end }}
								{{- if and $src600 $src1200 }}
									<img src="{{ $src600 | safeURL }}" srcset="{{ $src300 | safeURL }} 300w, {{ $src600 | safeURL }} 600w, {{ $src1200 | safeURL }} 1200w" sizes="{{ $sizes }}" loading="{{ $loadingAttr }}" {{ if ne $fetchPriority "" }}fetchpriority="{{ $fetchPriority }}"{{ end }} decoding="async" alt="{{ $alt }}" />
								{{- else }}
									<img src="{{ $abs | safeURL }}" loading="{{ $loadingAttr }}" {{ if ne $fetchPriority "" }}fetchpriority="{{ $fetchPriority }}"{{ end }} decoding="async" alt="{{ $alt }}" />
								{{- end }}
							{{- end }}
						</a>
					</li>
				{{- end }}
			{{- end }}
	{{- end }}
	</ul>
<script>
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}
const gridElement = document.querySelector('.masonry-grid');
const layoutMode = gridElement ? (gridElement.dataset.layout || 'columns') : 'columns';
const mobileGridQuery = typeof window !== 'undefined' && window.matchMedia ? window.matchMedia('(max-width: 600px)') : null;
function isGridMasonryActive() {
	if (!gridElement) return false;
	if (layoutMode === 'rows') return true;
	if (layoutMode === 'columns' && mobileGridQuery && mobileGridQuery.matches) return true;
	return false;
}
function clearGridSpans() {
	if (!gridElement) return;
	gridElement.querySelectorAll('li').forEach(li => {
		li.style.removeProperty('grid-row-end');
	});
}
function scheduleLoadingState(listItem) {
	if (!listItem || listItem.classList.contains('loaded')) return;
	if (listItem._masonryLoadingTimer) return;
	listItem._masonryLoadingTimer = setTimeout(() => {
		listItem.classList.add('loading');
		listItem._masonryLoadingTimer = null;
	}, 120);
}
function clearLoadingState(listItem) {
	if (!listItem) return;
	if (listItem._masonryLoadingTimer) {
		clearTimeout(listItem._masonryLoadingTimer);
		listItem._masonryLoadingTimer = null;
	}
	listItem.classList.remove('loading');
}
function updateGridSpan(imageElement) {
	if (!gridElement || !imageElement || !isGridMasonryActive()) return;
	const listItem = imageElement.closest('li');
	if (!listItem) return;
	const computedStyle = getComputedStyle(gridElement);
	const rowHeight = parseFloat(computedStyle.getPropertyValue('grid-auto-rows')) || 8;
	const gapY = parseFloat(computedStyle.getPropertyValue('grid-row-gap')) || parseFloat(computedStyle.getPropertyValue('grid-column-gap')) || 0;
	const span = Math.max(1, Math.ceil((imageElement.getBoundingClientRect().height + gapY) / (rowHeight + gapY)));
	listItem.style.gridRowEnd = `span ${span}`;
}
const refreshGridSpans = debounce(() => {
	if (!gridElement || !isGridMasonryActive()) return;
	gridElement.querySelectorAll('li img.visible').forEach(img => updateGridSpan(img));
}, 150);
function handleImage(imageElement) {
	if (!imageElement) return;
	const listItem = imageElement.closest('li');
	if (!listItem) return;
	if (!imageElement.complete) {
		scheduleLoadingState(listItem);
	}
	imageElement.addEventListener('load', function() {
		clearLoadingState(listItem);
		listItem.classList.add('loaded');
		imageElement.classList.add('visible');
		if (isGridMasonryActive()) {
			updateGridSpan(imageElement);
		} else {
			listItem.style.removeProperty('grid-row-end');
		}
	});
	imageElement.addEventListener('error', function() {
		clearLoadingState(listItem);
		listItem.innerHTML = 'Failed to load image';
		listItem.style.padding = '2rem';
		listItem.style.textAlign = 'center';
	});
	if (imageElement.complete) {
		clearLoadingState(listItem);
		listItem.classList.add('loaded');
		imageElement.classList.add('visible');
		if (isGridMasonryActive()) {
			updateGridSpan(imageElement);
		} else if (listItem) {
			listItem.style.removeProperty('grid-row-end');
		}
	}
}
if (gridElement) {
	const handleResize = () => {
		if (isGridMasonryActive()) {
			refreshGridSpans();
		} else {
			clearGridSpans();
		}
	};
	window.addEventListener('resize', handleResize);
}
const observer = new IntersectionObserver((entries) => {
	entries.forEach(entry => {
		if (entry.isIntersecting) {
			const img = entry.target;
			handleImage(img);
			observer.unobserve(img);
			if (isGridMasonryActive()) {
				refreshGridSpans();
			}
		}
	});
}, {
	rootMargin: '200px 0px'
});
document.querySelectorAll('.masonry-grid img').forEach(img => {
	if (!img.complete) {
		scheduleLoadingState(img.closest('li'));
	}
	if (img.loading === 'lazy') {
		observer.observe(img);
	} else {
		handleImage(img);
		if (isGridMasonryActive()) {
			refreshGridSpans();
		}
	}
});
if (mobileGridQuery && layoutMode === 'columns') {
	const handleMediaChange = () => {
		if (isGridMasonryActive()) {
			refreshGridSpans();
		} else {
			clearGridSpans();
		}
	};
	if (typeof mobileGridQuery.addEventListener === 'function') {
		mobileGridQuery.addEventListener('change', handleMediaChange);
	} else if (typeof mobileGridQuery.addListener === 'function') {
		mobileGridQuery.addListener(handleMediaChange);
	}
}
if (gridElement && isGridMasonryActive()) {
	refreshGridSpans();
} else {
	clearGridSpans();
}
</script>
{{ end }}
