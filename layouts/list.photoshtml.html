{{ define "main" }}
	{{- $columnsScratch := newScratch -}}
	{{- $columnsScratch.Set "desktop" 4 -}}
	{{- $columnsScratch.Set "tablet" 3 -}}
	{{- $columnsScratch.Set "mobile" 2 -}}
	{{- with .Site.Params.photos_columns_desktop }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "desktop" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_columns_tablet }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "tablet" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_columns_mobile }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "mobile" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- $optionsScratch := newScratch -}}
	{{- $optionsScratch.Set "showAll" true -}}
	{{- $optionsScratch.Set "layout" "columns" -}}
	{{- $optionsScratch.Set "excludeSections" (slice) -}}
	{{- with .Site.Params.photos_show_all }}
		{{- $value := lower (trim (printf "%v" .) " \r\n\t") -}}
		{{- if or (eq $value "false") (eq $value "0") (eq $value "no") (eq $value "off") }}
			{{- $optionsScratch.Set "showAll" false -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_layout_mode }}
		{{- $value := lower (trim (printf "%v" .) " \r\n\t") -}}
		{{- if in (slice "columns" "rows") $value }}
			{{- $optionsScratch.Set "layout" $value -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_exclude_sections }}
		{{- $raw := printf "%v" . -}}
		{{- $normalized := replaceRE `[;\s]+` "," $raw -}}
		{{- range split $normalized "," }}
			{{- $section := lower (trim . " ,.\r\n\t") -}}
			{{- if and $section (not (in ($optionsScratch.Get "excludeSections") $section)) }}
				{{- $optionsScratch.Add "excludeSections" (slice $section) -}}
			{{- end }}
		{{- end }}
	{{- end }}
	{{- $layoutMode := $optionsScratch.Get "layout" -}}
	<ul class="masonry-grid {{ if eq $layoutMode "rows" }}masonry-grid--rows{{ else }}masonry-grid--columns{{ end }}" data-layout="{{ $layoutMode }}" style="--masonry-columns-desktop: {{ $columnsScratch.Get "desktop" }}; --masonry-columns-tablet: {{ $columnsScratch.Get "tablet" }}; --masonry-columns-mobile: {{ $columnsScratch.Get "mobile" }};">
	{{- $list := .Site.RegularPages -}}
	{{- $category := index .Site.Taxonomies.categories (lower .Site.Params.photos_category) -}}
	{{- if $category }}
		{{- $list = $category.Pages -}}
	{{ end }}
	{{- $defaultExtensions := slice "jpg" "jpeg" "png" "gif" "webp" "avif" "heic" "heif" "tiff" "bmp" -}}
	{{- $configScratch := newScratch -}}
	{{- $configScratch.Set "extensions" $defaultExtensions -}}
	{{- with .Site.Params.photos_extensions }}
		{{- $raw := printf "%v" . -}}
		{{- $normalized := replaceRE `[;\s]+` "," $raw -}}
		{{- $candidateScratch := newScratch -}}
		{{- $candidateScratch.Set "list" (slice) -}}
		{{- range split $normalized "," }}
			{{- $ext := lower (replaceRE `[^a-z0-9]+` "" (trim . " .\r\n\t")) -}}
			{{- if and $ext (not (in ($candidateScratch.Get "list") $ext)) }}
				{{- $candidateScratch.Add "list" (slice $ext) -}}
			{{- end }}
		{{- end }}
		{{- if gt (len ($candidateScratch.Get "list")) 0 }}
			{{- $configScratch.Set "extensions" ($candidateScratch.Get "list") -}}
		{{- end }}
	{{- end }}
	{{- $extensions := $configScratch.Get "extensions" -}}
	{{- $imagePattern := printf `(?i)\.(?:%s)(?:\?.*)?$` (delimit $extensions "|") -}}
	{{- $markdownPattern := `!\[[^\]]*\]\(\s*([^)\s]+)(?:\s+["'][^"']*["'])?\s*\)` -}}
	{{- $htmlImgPattern := `<img[^>]+src=["']([^"']+)["'][^>]*>` -}}
	{{- $excludeSections := $optionsScratch.Get "excludeSections" -}}
	{{- range $page := $list }}
		{{- $section := lower (or $page.Section "") -}}
		{{- if not (in $excludeSections $section) }}
			{{- $scratch := newScratch -}}
			{{- $scratch.Set "photos" (slice) -}}
			{{- with $page.Params.photos }}
				{{- $photos := . -}}
				{{- $type := printf "%T" $photos -}}
			{{- if (hasPrefix $type "[]") }}
				{{- range $photos }}
					{{- $src := trim . " \r\n\t" -}}
					{{- if and $src (not (in ($scratch.Get "photos") $src)) }}
						{{- if gt (len (findRE $imagePattern $src)) 0 }}
							{{- $scratch.Add "photos" (slice $src) -}}
						{{- end }}
					{{- end }}
				{{- end }}
			{{- else if (ne $photos "") }}
				{{- $single := trim (printf "%v" $photos) " \r\n\t" -}}
				{{- if gt (len (findRE $imagePattern $single)) 0 }}
					{{- $scratch.Add "photos" (slice $single) -}}
				{{- end }}
			{{- end }}
		{{- end }}
		{{- with $page.RawContent }}
			{{- $raw := . -}}
			{{- range $match := findRE $markdownPattern $raw }}
				{{- $src := trim (replaceRE $markdownPattern `$1` $match) " \r\n\t" -}}
				{{- if and $src (gt (len (findRE $imagePattern $src)) 0) (not (in ($scratch.Get "photos") $src)) }}
					{{- $scratch.Add "photos" (slice $src) -}}
				{{- end }}
			{{- end }}
			{{- range $match := findRE $htmlImgPattern $raw }}
				{{- $src := trim (replaceRE $htmlImgPattern `$1` $match) " \r\n\t" -}}
				{{- if and $src (gt (len (findRE $imagePattern $src)) 0) (not (in ($scratch.Get "photos") $src)) }}
					{{- $scratch.Add "photos" (slice $src) -}}
				{{- end }}
			{{- end }}
		{{- end }}
		{{- $photos := $scratch.Get "photos" -}}
			{{- if gt (len $photos) 0 }}
				{{- $scratch.Set "photos_display" $photos -}}
				{{- if and (not ($optionsScratch.Get "showAll")) (gt (len $photos) 0) }}
					{{- $scratch.Set "photos_display" (slice (index $photos 0)) -}}
				{{- end }}
				{{- range $src := $scratch.Get "photos_display" }}
					<li>
						<a href="{{ $page.Permalink }}">
							<img src="{{ $src | absURL | safeURL }}" loading="lazy" decoding="async" alt="{{ with $page.Title }}{{ . | plainify }}{{ else }}Photo{{ end }}" />
						</a>
					</li>
				{{- end }}
			{{- end }}
		{{- end }}
	{{- end }}
	</ul>
<script>
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}
	const gridElement = document.querySelector('.masonry-grid');
	const layoutMode = gridElement ? (gridElement.dataset.layout || 'columns') : 'columns';
	function updateGridSpan(imageElement) {
		if (!gridElement || layoutMode !== 'rows' || !imageElement) return;
		const listItem = imageElement.closest('li');
		if (!listItem) return;
		const computedStyle = getComputedStyle(gridElement);
		const rowHeight = parseFloat(computedStyle.getPropertyValue('grid-auto-rows')) || 8;
		const gapY = parseFloat(computedStyle.getPropertyValue('grid-row-gap')) || parseFloat(computedStyle.getPropertyValue('grid-column-gap')) || 0;
		const span = Math.max(1, Math.ceil((imageElement.getBoundingClientRect().height + gapY) / (rowHeight + gapY)));
		listItem.style.gridRowEnd = `span ${span}`;
	}
	const refreshGridSpans = debounce(() => {
		if (!gridElement || layoutMode !== 'rows') return;
		gridElement.querySelectorAll('li img.visible').forEach(img => updateGridSpan(img));
	}, 150);
	function handleImage(imageElement) {
		if (!imageElement) return;
		const listItem = imageElement.closest('li');
		imageElement.addEventListener('load', function() {
			listItem.classList.add('loaded');
			imageElement.classList.add('visible');
			if (layoutMode === 'rows') {
				updateGridSpan(imageElement);
			}
		});
		imageElement.addEventListener('error', function() {
			listItem.innerHTML = 'Failed to load image';
			listItem.style.padding = '2rem';
			listItem.style.textAlign = 'center';
		});
		if (imageElement.complete) {
			listItem.classList.add('loaded');
			imageElement.classList.add('visible');
			if (layoutMode === 'rows') {
				updateGridSpan(imageElement);
			}
		}
	}
	if (gridElement && layoutMode === 'rows') {
		window.addEventListener('resize', refreshGridSpans);
	}
	const observer = new IntersectionObserver((entries) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				const img = entry.target;
				handleImage(img);
				observer.unobserve(img);
				if (layoutMode === 'rows') {
					refreshGridSpans();
				}
			}
		});
	}, {
		rootMargin: '50px'
	});
	document.querySelectorAll('.masonry-grid img').forEach(img => {
		if (img.loading === 'lazy') {
			observer.observe(img);
		} else {
			handleImage(img);
			if (layoutMode === 'rows') {
				refreshGridSpans();
			}
		}
	});
	if (gridElement && layoutMode === 'rows') {
		refreshGridSpans();
	}
</script>
{{ end }}
