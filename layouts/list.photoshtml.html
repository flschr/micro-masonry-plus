{{ define "main" }}
	{{- $columnsScratch := newScratch -}}
	{{- $columnsScratch.Set "desktop" 4 -}}
	{{- $columnsScratch.Set "tablet" 3 -}}
	{{- $columnsScratch.Set "mobile" 2 -}}
	{{- with .Site.Params.photos_columns_desktop }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "desktop" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_columns_tablet }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "tablet" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_columns_mobile }}
		{{- $value := replaceRE `[^0-9]+` "" (printf "%v" .) -}}
		{{- if ne $value "" }}
			{{- $parsed := int $value -}}
			{{- $columnsScratch.Set "mobile" (cond (lt $parsed 1) 1 (cond (gt $parsed 8) 8 $parsed)) -}}
		{{- end }}
	{{- end }}
	{{- $optionsScratch := newScratch -}}
	{{- $optionsScratch.Set "showAll" true -}}
	{{- $optionsScratch.Set "layout" "columns" -}}
	{{- with .Site.Params.photos_show_all }}
		{{- $value := lower (trim (printf "%v" .) " \r\n\t") -}}
		{{- if or (eq $value "false") (eq $value "0") (eq $value "no") (eq $value "off") }}
			{{- $optionsScratch.Set "showAll" false -}}
		{{- end }}
	{{- end }}
	{{- with .Site.Params.photos_layout_mode }}
		{{- $value := lower (trim (printf "%v" .) " \r\n\t") -}}
		{{- if in (slice "columns" "rows") $value }}
			{{- $optionsScratch.Set "layout" $value -}}
		{{- end }}
	{{- end }}
	{{- $layoutMode := $optionsScratch.Get "layout" -}}
	{{- $imageTracker := newScratch -}}
	{{- $imageTracker.Set "count" 0 -}}
	<ul class="masonry-grid {{ if eq $layoutMode "rows" }}masonry-grid--rows{{ else }}masonry-grid--columns{{ end }}" data-layout="{{ $layoutMode }}" style="--masonry-columns-desktop: {{ $columnsScratch.Get "desktop" }}; --masonry-columns-tablet: {{ $columnsScratch.Get "tablet" }}; --masonry-columns-mobile: {{ $columnsScratch.Get "mobile" }};">
	{{- $list := .Site.RegularPages -}}
	{{- $list = where $list "Type" "post" -}}
	{{- $category := index .Site.Taxonomies.categories (lower .Site.Params.photos_category) -}}
	{{- if $category }}
		{{- $list = $category.Pages -}}
	{{ end }}
	{{- $defaultExtensions := slice "jpg" "jpeg" "png" "gif" "webp" "avif" "heic" "heif" "tiff" "bmp" -}}
	{{- $configScratch := newScratch -}}
	{{- $configScratch.Set "extensions" $defaultExtensions -}}
	{{- with .Site.Params.photos_extensions }}
		{{- $raw := printf "%v" . -}}
		{{- $normalized := replaceRE `[;\s]+` "," $raw -}}
		{{- $candidateScratch := newScratch -}}
		{{- $candidateScratch.Set "list" (slice) -}}
		{{- range split $normalized "," }}
			{{- $ext := lower (replaceRE `[^a-z0-9]+` "" (trim . " .\r\n\t")) -}}
			{{- if and $ext (not (in ($candidateScratch.Get "list") $ext)) }}
				{{- $candidateScratch.Add "list" (slice $ext) -}}
			{{- end }}
		{{- end }}
		{{- if gt (len ($candidateScratch.Get "list")) 0 }}
			{{- $configScratch.Set "extensions" ($candidateScratch.Get "list") -}}
		{{- end }}
	{{- end }}
	{{- $extensions := $configScratch.Get "extensions" -}}
	{{- $imagePattern := printf `(?i)\.(?:%s)(?:\?.*)?$` (delimit $extensions "|") -}}
	{{- $markdownPattern := `!\[[^\]]*\]\(\s*([^)\s]+)(?:\s+["'][^"']*["'])?\s*\)` -}}
	{{- $htmlImgPattern := `<img[^>]+src=["']([^"']+)["'][^>]*>` -}}
	{{- range $page := $list }}
			{{- $scratch := newScratch -}}
			{{- $scratch.Set "photos" (slice) -}}
			{{- with $page.Params.photos }}
				{{- $photos := . -}}
				{{- $type := printf "%T" $photos -}}
			{{- if (hasPrefix $type "[]") }}
				{{- range $photos }}
					{{- $src := trim . " \r\n\t" -}}
					{{- if and $src (not (in ($scratch.Get "photos") $src)) }}
						{{- if gt (len (findRE $imagePattern $src)) 0 }}
							{{- $scratch.Add "photos" (slice $src) -}}
						{{- end }}
					{{- end }}
				{{- end }}
			{{- else if (ne $photos "") }}
				{{- $single := trim (printf "%v" $photos) " \r\n\t" -}}
				{{- if gt (len (findRE $imagePattern $single)) 0 }}
					{{- $scratch.Add "photos" (slice $single) -}}
				{{- end }}
			{{- end }}
		{{- end }}
		{{- with $page.RawContent }}
			{{- $raw := . -}}
			{{- range $match := findRE $markdownPattern $raw }}
				{{- $src := trim (replaceRE $markdownPattern `$1` $match) " \r\n\t" -}}
				{{- if and $src (gt (len (findRE $imagePattern $src)) 0) (not (in ($scratch.Get "photos") $src)) }}
					{{- $scratch.Add "photos" (slice $src) -}}
				{{- end }}
			{{- end }}
			{{- range $match := findRE $htmlImgPattern $raw }}
				{{- $src := trim (replaceRE $htmlImgPattern `$1` $match) " \r\n\t" -}}
				{{- if and $src (gt (len (findRE $imagePattern $src)) 0) (not (in ($scratch.Get "photos") $src)) }}
					{{- $scratch.Add "photos" (slice $src) -}}
				{{- end }}
			{{- end }}
		{{- end }}
		{{- $photos := $scratch.Get "photos" -}}
			{{- if gt (len $photos) 0 }}
				{{- $scratch.Set "photos_display" $photos -}}
				{{- if and (not ($optionsScratch.Get "showAll")) (gt (len $photos) 0) }}
					{{- $scratch.Set "photos_display" (slice (index $photos 0)) -}}
				{{- end }}
				{{- $display := $scratch.Get "photos_display" -}}
				{{- range $src := $display }}
					{{- $index := add ($imageTracker.Get "count") 1 -}}
					{{- $imageTracker.Set "count" $index -}}
					{{- $prefetchRows := 2 -}}
					{{- $prefetchThreshold := mul ($columnsScratch.Get "desktop") $prefetchRows -}}
					{{- $loadingAttr := "lazy" -}}
					{{- $fetchPriority := "" -}}
					{{- if le $index $prefetchThreshold }}
						{{- $loadingAttr = "eager" -}}
						{{- $fetchPriority = "high" -}}
					{{- end }}
					{{- $alt := "Photo" -}}
					{{- with $page.Title }}
						{{- $alt = plainify . -}}
					{{- end }}
					{{- $title := $page.Title -}}
					<li>
						<a href="{{ $page.Permalink }}">
							{{- $abs := $src | absURL -}}
							{{- if templates.Exists "partials/render-image.html" }}
								{{- $renderContext := dict "Destination" $src "Page" $page "Text" $alt "Title" $title -}}
								{{- $rendered := partial "render-image.html" $renderContext -}}
								{{- $extraAttrs := slice -}}
								{{- if not (in $rendered "loading=") }}
									{{- $extraAttrs = $extraAttrs | append (printf `loading="%s"` $loadingAttr) -}}
								{{- end }}
								{{- if not (in $rendered "decoding=") }}
									{{- $extraAttrs = $extraAttrs | append `decoding="async"` -}}
								{{- end }}
								{{- if and (ne $fetchPriority "") (not (in $rendered "fetchpriority=")) }}
									{{- $extraAttrs = $extraAttrs | append (printf `fetchpriority="%s"` $fetchPriority) -}}
								{{- end }}
								{{- if gt (len $extraAttrs) 0 }}
									{{- $attrsString := printf " %s" (delimit $extraAttrs " ") -}}
									{{- $rendered = replace $rendered "<img" (printf "<img%s" $attrsString) 1 -}}
								{{- end }}
								{{- $rendered | safeHTML -}}
							{{- else }}
								{{- $isMB := or (hasPrefix $abs "https://micro.blog/photos/") (hasPrefix $abs "http://micro.blog/photos/") -}}
								{{- $isMB = or $isMB (hasPrefix $abs "https://cdn.micro.blog/") -}}
								{{- $src600 := "" -}}
								{{- $src1200 := "" -}}
								{{- if $isMB }}
									{{- if or (hasPrefix $abs "https://micro.blog/photos/") (hasPrefix $abs "http://micro.blog/photos/") }}
										{{- $src600 = replaceRE `/photos/[^/]+/` "/photos/600x/" $abs -}}
										{{- $src1200 = replaceRE `/photos/[^/]+/` "/photos/1200x/" $abs -}}
									{{- else }}
										{{- $encoded := (printf "%s" $abs) | urlquery -}}
										{{- $src600 = printf "https://micro.blog/photos/600x/%s" $encoded -}}
										{{- $src1200 = printf "https://micro.blog/photos/1200x/%s" $encoded -}}
									{{- end }}
								{{- end }}
								{{- if and $src600 $src1200 }}
									{{- $desktopCols := $columnsScratch.Get "desktop" -}}
									{{- $gapCount := sub $desktopCols 1 -}}
									<img src="{{ $src600 | safeURL }}" srcset="{{ $src600 | safeURL }} 600w, {{ $src1200 | safeURL }} 1200w" sizes="(max-width: 600px) 100vw, calc((100vw - ({{ $gapCount }} * 1rem)) / {{ $desktopCols }})" loading="{{ $loadingAttr }}" {{ if ne $fetchPriority "" }}fetchpriority="{{ $fetchPriority }}"{{ end }} decoding="async" alt="{{ $alt }}" />
								{{- else }}
									<img src="{{ $abs | safeURL }}" loading="{{ $loadingAttr }}" {{ if ne $fetchPriority "" }}fetchpriority="{{ $fetchPriority }}"{{ end }} decoding="async" alt="{{ $alt }}" />
								{{- end }}
							{{- end }}
						</a>
					</li>
				{{- end }}
			{{- end }}
	{{- end }}
	</ul>
<script>
	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}
const gridElement = document.querySelector('.masonry-grid');
const layoutMode = gridElement ? (gridElement.dataset.layout || 'columns') : 'columns';
function scheduleLoadingState(listItem) {
	if (!listItem || listItem.classList.contains('loaded')) return;
	if (listItem._masonryLoadingTimer) return;
	listItem._masonryLoadingTimer = setTimeout(() => {
		listItem.classList.add('loading');
		listItem._masonryLoadingTimer = null;
	}, 120);
}
function clearLoadingState(listItem) {
	if (!listItem) return;
	if (listItem._masonryLoadingTimer) {
		clearTimeout(listItem._masonryLoadingTimer);
		listItem._masonryLoadingTimer = null;
	}
	listItem.classList.remove('loading');
}
function updateGridSpan(imageElement) {
	if (!gridElement || layoutMode !== 'rows' || !imageElement) return;
	const listItem = imageElement.closest('li');
	if (!listItem) return;
	const computedStyle = getComputedStyle(gridElement);
	const rowHeight = parseFloat(computedStyle.getPropertyValue('grid-auto-rows')) || 8;
	const gapY = parseFloat(computedStyle.getPropertyValue('grid-row-gap')) || parseFloat(computedStyle.getPropertyValue('grid-column-gap')) || 0;
	const span = Math.max(1, Math.ceil((imageElement.getBoundingClientRect().height + gapY) / (rowHeight + gapY)));
	listItem.style.gridRowEnd = `span ${span}`;
}
const refreshGridSpans = debounce(() => {
	if (!gridElement || layoutMode !== 'rows') return;
	gridElement.querySelectorAll('li img.visible').forEach(img => updateGridSpan(img));
}, 150);
function handleImage(imageElement) {
	if (!imageElement) return;
	const listItem = imageElement.closest('li');
	if (!listItem) return;
	if (!imageElement.complete) {
		scheduleLoadingState(listItem);
	}
	imageElement.addEventListener('load', function() {
		clearLoadingState(listItem);
		listItem.classList.add('loaded');
		imageElement.classList.add('visible');
		if (layoutMode === 'rows') {
			updateGridSpan(imageElement);
		}
	});
	imageElement.addEventListener('error', function() {
		clearLoadingState(listItem);
		listItem.innerHTML = 'Failed to load image';
		listItem.style.padding = '2rem';
		listItem.style.textAlign = 'center';
	});
	if (imageElement.complete) {
		clearLoadingState(listItem);
		listItem.classList.add('loaded');
		imageElement.classList.add('visible');
		if (layoutMode === 'rows') {
			updateGridSpan(imageElement);
		}
	}
}
if (gridElement && layoutMode === 'rows') {
	window.addEventListener('resize', refreshGridSpans);
}
const observer = new IntersectionObserver((entries) => {
	entries.forEach(entry => {
		if (entry.isIntersecting) {
			const img = entry.target;
			handleImage(img);
			observer.unobserve(img);
			if (layoutMode === 'rows') {
				refreshGridSpans();
			}
		}
	});
}, {
	rootMargin: '200px 0px'
});
document.querySelectorAll('.masonry-grid img').forEach(img => {
	if (!img.complete) {
		scheduleLoadingState(img.closest('li'));
	}
	if (img.loading === 'lazy') {
		observer.observe(img);
	} else {
		handleImage(img);
		if (layoutMode === 'rows') {
			refreshGridSpans();
		}
	}
});
if (gridElement && layoutMode === 'rows') {
	refreshGridSpans();
}
</script>
{{ end }}
